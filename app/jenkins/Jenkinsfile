pipeline {
    agent any

    tools {
        nodejs 'nodejs-project'
    }

    stages {
        stage('Install') {
            steps {
                echo 'Installing dependencies...'
                sh 'npm install --no-audit --no-fund'
            }
        }

        stage('Start') {
            steps {
                echo 'Starting the Node.js application...'
                sh '''
                    nohup npm start > server.log 2>&1 &
                    sleep 3
                    echo "=== Server log output ==="
                    tail -n 20 server.log
                '''
            }
        }

        stage('Stop') {
            steps {
                echo 'Stopping the Node.js application...'
                sh '''
                    npm stop || pkill -f "node app/server.js" || true
                    echo "=== Server stopped successfully ==="
                '''
            }
        }
    }

    post {
        always {
            echo 'Cleanup: ensuring the app is stopped'
            sh 'npm stop || pkill -f "node app/server.js" || true'
            echo 'Displaying final log snapshot:'
            sh 'tail -n 30 server.log || true'
        }
    }
}
