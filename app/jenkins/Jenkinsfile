pipeline {
    agent any

    parameters {
        booleanParam(name: 'STOP_APP', defaultValue: false, description: 'If true, pipeline will run the Stop stage after Start. Default: false')
    }

    tools {
        nodejs 'nodejs-project'
    }

    stages {
        stage('Install') {
            steps {
                echo 'Installing dependencies...'
                sh 'npm install --no-audit --no-fund'
            }
        }

        stage('Start') {
            steps {
                echo 'Starting the Node.js application...'
                sh '''
                    nohup npm start > server.log 2>&1 &
                    sleep 3
                    echo "=== Server log output ==="
                    tail -n 20 server.log
                '''
            }
        }

        stage('Stop') {
            when {
                expression { return params.STOP_APP == true }
            }
            steps {
                echo 'Stopping the Node.js application...'
                sh '''
                    npm stop || pkill -f "node app/server.js" || true
                    echo "=== Server stopped successfully ==="
                '''
            }
        }
    }

    post {
        always {
            echo 'Post-build: show a final log snapshot (no automatic stop)'
            sh 'echo "--- Tail server.out.log (if present) ---" || true'
            sh 'tail -n 30 server.out.log || tail -n 30 server.log || true'
        }
    }
}